"use strict";class Chord{constructor(t,i,e,s){this.base=t,this.alteration=i,this.inversion=e,this.relativeKey=s}static parse(t){var i=t.match(/^((b|#|)(III|iii|VII|vii|II|ii|IV|iv|VI|vi|I|i|V|v))(o7|7|)([a-d])?(\/((b|#|)(III|iii|VII|vii|II|ii|IV|iv|VI|vi|I|i|V|v)))?$/);if(null===i)throw`Could not parse chord '${t}'`;return new Chord(Numeral.parse(i[1]),i[4],i[5]?Chord.INVERSIONS.indexOf(i[5]):0,i[6]?Numeral.parse(i[7]):Numeral.parse("I"))}resolve(t){if(null===this.base)throw"Cannot resolve chord with base 'null'";var i=(t=this.relativeKey?new Key(t.degree(this.relativeKey.getDegree()),this.relativeKey.getTonality()):t).degree(this.base.getDegree()).alterAccidental(this.base.getAccidental()).semitones()-t.degree(0).semitones(),e=t.degree(this.base.getDegree()+2,i+(this.base.getTonality()?4:3));let s,r;switch(this.alteration){case"":s=t.degree(this.base.getDegree()+4);break;case"o7":s=t.degree(this.base.getDegree()+4,6+i),r=t.degree(this.base.getDegree()+6,9+i);break;case"7":s=t.degree(this.base.getDegree()+4),r=t.degree(this.base.getDegree()+6)}return new Resolution(t.degree(this.base.getDegree()).alterAccidental(this.base.getAccidental()),e,s,r,this.inversion)}progression(t){const i=t["SPECIFIC_"+this.relativeKey.string()],e=i?.[this.toStringStem()].map(Chord.parse),s=this.relativeKey.getTonality()?t.COMMON_MAJOR:t.COMMON_MINOR;t=s[this.toStringStem()].map(t=>{const i=Chord.parse(t);return i.relativeKey=this.relativeKey,i});return e?e.concat(t):t}getInversion(){return this.inversion}setInversion(t){return this.inversion=t,this}toStringStem(){return this.base?this.base.string()+this.alteration+(this.inversion?Chord.INVERSIONS[this.inversion]:""):"start"}string(){let t=this.toStringStem();return 0===this.relativeKey.getDegree()&&0===this.relativeKey.getAccidental()||(t+="/"+this.relativeKey.string()),t}}Chord.INVERSIONS=["a","b","c","d"];const FULL={COMMON_MAJOR:{start:["I","V","IV","ii","vi","iii"],I:["viib","iiic","iiib","iii","vic","vib","vi","ii7d","ii7c","ii7b","ii7","iic","iib","ii","IVc","IVb","IV","V7d","V7c","V7b","V7","Vc","Vb","V","Ic","Ib","I"],Ib:["IV","ii7b","ii7","iib","ii","V7d","V7c","Vc","vi","Ic","I"],Ic:["V7","V"],ii:["Ic","V","vi","iii","IV"],iib:["Ic","V"],iic:["iiib"],ii7:["Ic","V"],ii7b:["Ic","V"],ii7c:[],ii7d:["Vb"],iii:["viib","vi","IV","ii","vi"],iiib:["vi"],iiic:[],IV:["vi","vii","iii","Ic","I","V","ii"],IVb:["vii","Ic","I"],IVc:[],V:["iiic","iiib","iii","vi","iic","iib","ii","IV","Ic","Ib","I","Vb"],Vb:["vi","I"],Vc:["Ib","I"],V7:["vi","I"],V7b:["iiib","iii","vi","I"],V7c:["Ib","I"],V7d:["iii","Ib"],vi:["ii7d","ii7c","ii7b","ii7","iic","iib","ii","iiic","iiib","iii","Vb","V","IVb","IV","Ib"],vib:["ii"],vic:[],vii:["V/vi","iii","ii","V"],viib:["V/vi","I","iii"],viic:[],vii7:[],vii7b:[],vii7c:[],vii7d:[],viio7:[],viio7b:[],viio7c:[],viio7d:[]},COMMON_MINOR:{start:["i","iv","V"],i:["VI","V7d","V7c","V7b","V7","Vc","Vb","V","#viib"],ib:["i"],ic:[],bII:[],bIIb:[],bIIc:[],ii:[],iib:[],iic:[],ii7:[],ii7b:[],ii7c:[],ii7d:[],III:["VI"],IIIb:[],IIIc:[],iv:["III","iv"],ivb:[],ivc:[],V:["bIIb","i"],Vb:["i"],Vc:["ib","i"],V7:["i"],V7b:["i"],V7c:["ib","i"],V7d:["ib"],VI:[],VIb:[],VIc:[],VII:[],VIIb:[],VIIc:[],"#vii":[],"#viib":["ib","i"],"#viic":[],"#viio7":["i"],"#viio7b":["ib","i"],"#viio7c":["ib"],"#viio7d":["ic"]},SPECIFIC_I:{start:[],I:["vii7/V"],Ib:[],Ic:[],ii:[],iib:[],iic:[],ii7:[],ii7b:[],ii7c:[],ii7d:[],iii:[],iiib:[],iiic:[],IV:[],IVb:[],IVc:[],V:["vii/V","V7d/V","V7c/V","V7b/V","V7/V"],Vb:[],Vc:[],V7:[],V7b:[],V7c:[],V7d:[],vi:["Vb/V"],vib:[],vic:[],vii:[],viib:[],viic:[],vii7:[],vii7b:[],vii7c:[],vii7d:[],viio7:[],viio7b:[],viio7c:[],viio7d:[]},SPECIFIC_IV:{start:["I","V","IV","ii","vi","iii"],I:[],Ib:[],Ic:[],ii:[],iib:[],iic:[],ii7:[],ii7b:[],ii7c:[],ii7d:[],iii:[],iiib:[],iiic:[],IV:[],IVb:[],IVc:[],V:[],Vb:[],Vc:[],V7:[],V7b:[],V7c:[],V7d:[],vi:[],vib:[],vic:[],vii:[],viib:[],viic:[],vii7:[],vii7b:[],vii7c:[],vii7d:[],viio7:[],viio7b:[],viio7c:[],viio7d:[]},SPECIFIC_V:{I:["V/I"],Ib:[],Ic:[],ii:[],iib:[],iic:[],ii7:[],ii7b:[],ii7c:[],ii7d:[],iii:[],iiib:[],iiic:[],IV:[],IVb:[],IVc:[],V:[],Vb:[],Vc:[],V7:[],V7b:["Ic/I","V/I"],V7c:["Vb/I"],V7d:[],vi:[],vib:[],vic:[],vii:[],viib:[],viic:[],vii7:["Ic/I","V/I"],vii7b:[],vii7c:[],vii7d:[],viio7:[],viio7b:[],viio7c:[],viio7d:[]}},PRIMARY_A={COMMON_MAJOR:{start:["I","IV","V"],I:["IV","V","I"],IV:["V","I","IV"],V:["I","IV","V"]},COMMON_MINOR:{start:["i","iv","V"],i:["iv","V","i"],iv:["V","i","iv"],V:["i","iv","V"]}},PRIMARY_AB={COMMON_MAJOR:{start:["I","Ib","IVb","IV","V","Vb"],I:["IVb","IV","Vb","V","Ib","I"],Ib:["IV","IVb","V","Vb","I","Ib"],IV:["Vb","V","Ib","I","IVb","IV"],IVb:["V","Vb","I","Ib","IV","IVb"],V:["Ib","I","IVb","IV","Vb","V"],Vb:["I","Ib","IV","IVb","V","Vb"]},COMMON_MINOR:{start:["i","ib","ivb","iv","V","Vb"],i:["ivb","iv","Vb","V","ib","i"],ib:["iv","ivb","V","Vb","i","ib"],iv:["Vb","V","ib","i","ivb","iv"],ivb:["V","Vb","i","ib","iv","ivb"],V:["ib","i","ivb","iv","Vb","V"],Vb:["i","ib","iv","ivb","V","Vb"]}},PRIMARY_ABC={COMMON_MAJOR:{start:["I","Ib","Ic","IVc","IVb","IV","V","Vb","Vc"],I:["IVb","IV","Vb","V","Ib","I"],Ib:["IV","IVb","V","Vb","I","Ib"],IV:["Vb","V","Ib","I","IVb","IV"],IVb:["V","Vb","I","Ib","IV","IVb"],V:["Ib","I","IVb","IV","Vb","V"],Vb:["I","Ib","IV","IVb","V","Vb"],Vc:[]},COMMON_MINOR:{start:["i","ib","ivb","iv","V","Vb"],i:["ivb","iv","Vb","V","ib","i"],ib:["iv","ivb","V","Vb","i","ib"],iv:["Vb","V","ib","i","ivb","iv"],ivb:["V","Vb","i","ib","iv","ivb"],V:["ib","i","ivb","iv","Vb","V"],Vb:["i","ib","iv","ivb","V","Vb"]}};class Event{constructor(t,i,e,s,r){this.map=0,this.s=t,this.a=i,this.t=e,this.b=s,this.cadence=r}getS(){return this.s}setS(t){return this.s=t,this}getA(){return this.a}setA(t){return this.a=t,this}getT(){return this.t}setT(t){return this.t=t,this}getB(){return this.b}setB(t){return this.b=t,this}getPart(t){switch(t){case"s":return this.getS();case"a":return this.getA();case"t":return this.getT();case"b":return this.getB()}}setPart(t,i){switch(t){case"s":return this.setS(i);case"a":return this.setA(i);case"t":return this.setT(i);case"b":return this.setB(i)}}duration(){return this.getS().duration()??this.getA().duration??this.getT().duration??this.getB().duration??0}getChord(){return this.chord}setChord(t){return this.chord=t,this}isCadence(){return this.cadence}}class Group{constructor(t,i){this.notes=t,this.index=i}static parse(t){if(t.startsWith("(")&&t.endsWith(")")){var i=t.slice(1,-1).split(",").map(t=>Note.parse(t));return new Group(i,0)}return new Group([Note.parse(t)],0)}static empty(){return new Group([],0)}main(){return this.getNotes()[this.getIndex()]}at(t){return t<0&&(t=this.getNotes().length+t),this.getNotes()[t]}duration(){return this.getNotes().map(t=>t.getDuration()).reduce((t,i)=>t+i)}getNotes(){return this.notes}setNotes(t){return this.notes=t,this}getIndex(){return this.index}setIndex(t){return this.index=t,this}string(){return this.getNotes().map(t=>t.string()).join(" ")}}const JSB={};JSB.Tone=Tone,JSB.Chord=Chord,JSB.Dict.FULL=FULL,JSB.Dict.PRIMARY_A=PRIMARY_A,JSB.Dict.PRIMARY_AB=PRIMARY_AB,JSB.Dict.PRIMARY_ABC=PRIMARY_ABC,JSB.Event=Event,JSB.Group=Group,JSB.Key=Key,JSB.Note=Note,JSB.Numeral=Numeral,JSB.Piece=Piece,JSB.Resolution=Resolution,JSB.Pitch=Pitch,JSB.Printable=Printable,module.exports=JSB;class Key{constructor(t,i){this.tone=t,this.tonality=i}static parse(t){var i=t.match(/^(C|D|E|F|G|A|B)(bb|x|b|#|) (major|minor)$/);if(null===i)throw`Could not parse key '${t}'`;return new Key(Tone.parse(i[1]+i[2]),"major"===i[3])}degree(t,i){t%=7,i=i??(this.getTonality()?[0,2,4,5,7,9,11]:[0,2,3,5,7,8,10])[t];const e=new Tone((this.getTone().getLetter()+t)%7,0);return e.setAccidental((i-e.semitones()+this.getTone().semitones()+18)%12-6),e}accidentals(){let t=2*this.getTone().getLetter()%7+7*this.getTone().getAccidental();return 3===this.getTone().getLetter()&&(t-=7),this.tonality||(t-=3),t}signature(){var t=this.accidentals();return[Math.floor((t+5)/7),Math.floor((t+3)/7),Math.floor((t+1)/7),Math.floor((t+6)/7),Math.floor((t+4)/7),Math.floor((t+2)/7),Math.floor(t/7)]}getTone(){return this.tone}setTone(t){return this.tone=t,this}getTonality(){return this.tonality}setTonality(t){return this.tonality=t,this}string(){return this.getTone().string()+" "+(this.getTonality()?"major":"minor")}}class Note{constructor(t,i){this.pitch=t,this.duration=i}static parse(t){var i=t.match(/^([A-G](bb|b|#|x|)[1-6])(_*)(\/*)(\.*)$/);if(null===i)throw`Could not parse note '${t}'`;return new Note(Pitch.parse(i[1]),2**(i[3].length-i[4].length)*1.5**i[5].length)}getPitch(){return this.pitch}setPitch(t){return this.pitch=t,this}getDuration(){return this.duration}setDuration(t){return this.duration=t,this}string(){let t=this.getPitch().string();switch(this.getDuration()){case.25:t+="𝅘𝅥𝅯";break;case.5:t+="♪";break;case.75:t+="♪.";break;case 1:t+="♩";break;case 1.5:t+="♩.";break;case 2:t+="𝅗𝅥";break;case 3:t+="𝅗𝅥.";break;case 4:t+="𝅝";break;case 6:t+="𝅝."}return t}}class Numeral{constructor(t,i,e){this.accidental=t,this.degree=i,this.tonality=e}static parse(t){const i=t.match(/^(b|#|)(III|iii|VII|vii|II|ii|IV|iv|VI|vi|I|i|V|v)$/);if(null===i)throw`Could not parse numeral '${t}'`;return new Numeral(Tone.ACCIDENTALS.indexOf(i[1]),Numeral.NUMERALS.indexOf(i[2].toLowerCase()),i[2]===i[2].toUpperCase())}getAccidental(){return this.accidental}setAccidental(t){return this.accidental=t,this}getDegree(){return this.degree}setDegree(t){return this.degree=t,this}getTonality(){return this.tonality}setTonality(t){return this.tonality=t,this}string(){return Tone.ACCIDENTALS[this.accidental]+Numeral.NUMERALS[this.degree][this.tonality?"toUpperCase":"toLowerCase"]()}}Numeral.NUMERALS=["i","ii","iii","iv","v","vi","vii"];class Piece{constructor(){this.input=[],this.output=[],this.time={bar:0,event:0},this.maxTime={bar:0,event:0},this.key=Key.parse("C major"),this.dictionary=FULL}parse(t,e){var s,r;const n=t.split(/[[|\]]/).filter(t=>""!==t).map(t=>t.split(" ").filter(t=>""!==t));for(let i=0;i<n.length;++i){(s=this.getInput())[i]??(s[i]=[]);for(let t=0;t<n[i].length;++t){var a=n[i][t].endsWith("@");a&&(n[i][t]=n[i][t].slice(0,-1)),(r=this.getInput()[i])[t]??(r[t]=new Event(Group.empty(),Group.empty(),Group.empty(),Group.empty(),a)),this.getInput()[i][t][e]=Group.parse(n[i][t])}}return this}previousPreviousOutputEvent(){let{bar:t,event:i}=this.time;if(--i<0){if(--t<0)return;i=this.getOutput()[t].length-1}if(--i<0){if(--t<0)return;i=this.getOutput()[t].length-1}return this.getOutput()[t][i]}previousOutputEvent(){let{bar:t,event:i}=this.time;if(--i<0){if(--t<0)return;i=this.getOutput()[t].length-1}return this.getOutput()[t][i]}outputEvent(){return this.getOutput()[this.getTime().bar][this.getTime().event]}harmonise(){for(this.setOutput([]),this.setMaxTime({bar:0,event:0}),this.setTime({bar:0,event:0});this.getTime().bar!==this.getInput().length;this.step()){if(this.getTime().bar<0)throw"Failed to harmonise.";this.getTime().bar>this.getMaxTime().bar?this.setMaxTime({...this.getTime()}):this.getTime().bar===this.getMaxTime().bar&&this.getTime().event>=this.getMaxTime().event&&(this.getMaxTime().event=this.getTime().event)}return this}step(){var t,i;const e=this.getInput()[this.getTime().bar][this.getTime().event];(t=this.getOutput())[i=this.time.bar]??(t[i]=[]),(t=this.getOutput()[this.time.bar])[i=this.time.event]??(t[i]=new Event(Group.empty(),Group.empty(),Group.empty(),Group.empty(),e.isCadence()));const s=this.previousOutputEvent()?.getChord()??new Chord(null,"",0,new Numeral(0,0,this.key.getTonality()));for(var r=s.progression(this.dictionary).filter(t=>!this.outputEvent().isCadence()||["I","i","V"].includes(t.toStringStem()));this.outputEvent().map<r.length;++this.outputEvent().map){const h=r[this.outputEvent().map],o=h.resolve(this.key),c={s:void 0!==e.getS().main(),a:void 0!==e.getA().main(),t:void 0!==e.getT().main(),b:void 0!==e.getB().main()};if(["s","a","t","b"].filter(t=>c[t]).map(t=>e.getPart(t).duration()).some((t,i,e)=>t!==e[0]))throw"Not all parts have the same duration.";if(!c.s)throw"Soprano line is not defined.";this.outputEvent().setS(e.getS()),this.outputEvent().setA(e.getA()),this.outputEvent().setT(e.getT()),this.outputEvent().setB(e.getB());var n={a:this.previousOutputEvent()?.getA().at(-1).getPitch()??Pitch.parse("D4"),t:this.previousOutputEvent()?.getT().at(-1).getPitch()??Pitch.parse("B3"),b:this.previousOutputEvent()?.getB().at(-1).getPitch()??Pitch.parse("Eb3")};if(!c.b){const u=o.bass().near(n.b),v=u.filter(t=>28<=t.semitones()&&t.semitones()<=48&&t.semitones()<=this.outputEvent().getS().main().getPitch().semitones()-10)[0];this.outputEvent().setB(v.group(this.outputEvent().duration()))}if(!(o.excludes(e.getS().main()?.getPitch().getTone())||o.excludes(e.getA().main()?.getPitch().getTone())||o.excludes(e.getT().main()?.getPitch().getTone())||o.excludes(e.getB().main()?.getPitch().getTone()))&&((!e.getB().main()||e.getB().main().getPitch().getTone().equals(o.bass()))&&(2!==s.getInversion()||this.previousPreviousOutputEvent()?.getChord()?.string()!==h.string()))){const b=o.getSeventh()?[1,1,1,1]:[2,1,2,0];for(const g of["s","a","t","b"]){const I=[o.getRoot(),o.getThird(),o.getFifth(),o.getSeventh()].filter(t=>void 0!==t);var a=I.findIndex(t=>t.equals(this.outputEvent().getPart(g).main()?.getPitch().getTone()));-1!==a&&--b[a]}if(void 0===o.getSeventh()){if(0===b[0]&&(b[2]=1,0===b[2]))continue;0===b[2]&&(b[0]=1)}if(!b.some(t=>t<0)){let i;const V=b.map((t,i)=>1===t?o.at(i):void 0).filter(t=>void 0!==t);let e,s;if(c.a||c.t)i=c.a&&!c.t?(e=this.outputEvent().getA().main().getPitch(),1===V.length?[{a:e,t:s=V[0].near(n.t)[0],score:this.score(e,s)}]:[{a:e,t:s=V[0].near(n.t)[0],score:this.score(e,s)},{a:e,t:s=V[1].near(n.t)[0],score:this.score(e,s)}]):!c.a&&c.t?(s=this.outputEvent().getT().main().getPitch(),1===V.length?[{a:e=V[0].near(n.a)[0],t:s,score:this.score(e,s)}]:[{a:e=V[0].near(n.a)[0],t:s,score:this.score(e,s)},{a:e=V[1].near(n.a)[0],t:s,score:this.score(e,s)}]):[{a:e=this.outputEvent().getA().main().getPitch(),t:s=this.outputEvent().getT().main().getPitch(),score:this.score(e,s)}];else{let t=o.at(b.findIndex(t=>2===t));switch(V.length){case 1:const l={a:e=V[0].near(n.a)[0],t:s=t.near(n.t)[0],score:this.score(e,s)},p={a:e=t.near(n.a)[0],t:s=V[0].near(n.t)[0],score:this.score(e,s)},d={a:e=t.near(n.a)[0],t:s=t.near(n.t)[0],score:this.score(e,s)};i=[l,p,d].sort((t,i)=>t.score-i.score);break;case 2:const m={a:e=V[0].near(n.a)[0],t:s=V[1].near(n.t)[0],score:this.score(e,s)},T={a:e=V[1].near(n.a)[0],t:s=V[0].near(n.t)[0],score:this.score(e,s)};i=[m,T].sort((t,i)=>t.score-i.score);break;case 3:const P={a:e=V[0].near(n.a)[0],t:s=V[1].near(n.t)[0],score:this.score(e,s)},E={a:e=V[1].near(n.a)[0],t:s=V[0].near(n.t)[0],score:this.score(e,s)},O={a:e=V[1].near(n.a)[0],t:s=V[2].near(n.t)[0],score:this.score(e,s)},f={a:e=V[2].near(n.a)[0],t:s=V[1].near(n.t)[0],score:this.score(e,s)};i=[P,E,O,f].sort((t,i)=>t.score-i.score)}}for(const A of i)if(A.score!==1/0&&(this.outputEvent().setA(A.a.group(this.outputEvent().duration())),this.outputEvent().setT(A.t.group(this.outputEvent().duration())),!(this.checkParallel("s","a")||this.checkParallel("s","t")||this.checkParallel("s","b")||this.checkParallel("a","t")||this.checkParallel("a","b")||this.checkParallel("t","b"))))return this.outputEvent().setChord(h),void(++this.getTime().event===this.getInput()[this.getTime().bar].length&&(this.getTime().event=0,++this.getTime().bar))}}}this.outputEvent().map=0,--this.getTime().event<0&&0<=--this.getTime().bar&&(this.getTime().event=this.getInput()[this.getTime().bar].length-1),0<=this.getTime().bar&&++this.outputEvent().map}score(t,i){var e=this.outputEvent().getS().main().getPitch().semitones(),s=t.semitones(),r=i.semitones(),n=this.outputEvent().getB().main().getPitch().semitones();const a=this.previousOutputEvent()?.getA().at(-1).getPitch()??Pitch.parse("D4"),h=this.previousOutputEvent()?.getT().at(-1).getPitch()??Pitch.parse("B3");t=Math.abs(s-a.semitones()),i=Math.abs(r-h.semitones());if(7<t||7<i||e<s||s<r||r<n||64<s||s<43||r<40||52<r)return 1/0;e-=s,r=s-r;return t+i+Math.sqrt((e*e+r*r)/2-(e+r)**2/4)}checkParallel(t,i){const e=this.previousOutputEvent();if(void 0===e)return!1;var s=e.getPart(t).at(-1).getPitch().semitones(),r=e.getPart(i).at(-1).getPitch().semitones(),n=this.outputEvent().getPart(t).at(0).getPitch().semitones(),a=this.outputEvent().getPart(i).at(0).getPitch().semitones(),t=(s-r)%12,i=(n-a)%12;return(0==t&&0==i||7==t&&7==i)&&s!==n&&r!==a}getInput(){return this.input}setInput(t){return this.input=t,this}getOutput(){return this.output}setOutput(t){return this.output=t,this}getTime(){return this.time}setTime(t){return this.time=t,this}getMaxTime(){return this.maxTime}setMaxTime(t){return this.maxTime=t,this}getKey(){return this.key}setKey(t){return this.key=t,this}getDictionary(){return this.dictionary}setDictionary(t){return this.dictionary=t,this}string(){return`[${this.getOutput().map(t=>t.map(t=>t.getS().string().padEnd(8)).join(" ")).join("|")}]
[${this.getOutput().map(t=>t.map(t=>t.getA().string().padEnd(8)).join(" ")).join("|")}]
[${this.getOutput().map(t=>t.map(t=>t.getT().string().padEnd(8)).join(" ")).join("|")}]
[${this.getOutput().map(t=>t.map(t=>t.getB().string().padEnd(8)).join(" ")).join("|")}]
[${this.getOutput().map(t=>t.map(t=>t.getChord()?.string().padEnd(8)).join(" ")).join("|")}]`}}class Pitch{constructor(t,i){this.tone=t,this.octave=i}static parse(t){var i=t.match(/^([A-G](bb|b|#|x|))([1-6])$/);if(null===i)throw`Could not parse pitch '${t}'`;return new Pitch(Tone.parse(i[1]),Number(i[3]))}semitones(){return this.getTone().semitones()+12*this.getOctave()}near(t){const i=new Pitch(t,this.getOctave()-1),e=new Pitch(t,this.getOctave()),s=new Pitch(t,this.getOctave()+1);return[i,e,s].sort((t,i)=>Math.abs(this.semitones()-t.semitones())-Math.abs(this.semitones()-i.semitones()))}getTone(){return this.tone}setTone(t){return this.tone=t,this}getOctave(){return this.octave}setOctave(t){return this.octave=t,this}string(){return this.getTone().string()+this.getOctave()}group(t){return new Group([new Note(this,t)],0)}}class Resolution{constructor(t,i,e,s,r){this.root=t,this.third=i,this.fifth=e,this.seventh=s,this.inversion=r}at(t){switch(t){case 0:return this.root;case 1:return this.third;case 2:return this.fifth;case 3:return this.seventh}}bass(){return this.at(this.inversion)}excludes(t){return void 0!==t&&!(this.root?.equals(t)||this.third?.equals(t)||this.fifth?.equals(t)||this.seventh?.equals(t))}getRoot(){return this.root}setRoot(t){return this.root=t,this}getThird(){return this.third}setThird(t){return this.third=t,this}getFifth(){return this.fifth}setFifth(t){return this.fifth=t,this}getSeventh(){return this.seventh}setSeventh(t){return this.seventh=t,this}string(){const t=[this.root,this.third,this.fifth,this.seventh].filter(t=>t).map(t=>t?.string());return t[this.inversion]=`{${t[this.inversion]}}`,t.join(" ")}}class Tone{constructor(t,i){this.letter=t,this.accidental=i}static parse(t){var i=t.match(/^([A-G])(bb|x|b|#|)$/);if(null===i)throw`Could not parse tone '${t}'`;return new Tone(Tone.LETTERS.indexOf(i[1]),Tone.ACCIDENTALS.indexOf(i[2]))}semitones(){return Tone.PITCHES[this.letter]+this.accidental}equals(t){return void 0!==t&&(this.letter===t.letter&&this.accidental===t.accidental)}near(e){const t=new Pitch(this,e.getOctave()-1),i=new Pitch(this,e.getOctave()),s=new Pitch(this,e.getOctave()+1);return[t,i,s].sort((t,i)=>Math.abs(e.semitones()-t.semitones())-Math.abs(e.semitones()-i.semitones()))}getLetter(){return this.letter}setLetter(t){return this.letter=t,this}getAccidental(){return this.accidental}setAccidental(t){return-2<=t&&t<=2&&(this.accidental=t),this}alterAccidental(t){t=this.accidental+t;return-2<=t&&t<=2&&(this.accidental=t),this}string(){return Tone.LETTERS[this.letter]+Tone.ACCIDENTALS[this.accidental]}}Tone.ACCIDENTALS=["","#","x"],Tone.ACCIDENTALS[-2]="bb",Tone.ACCIDENTALS[-1]="b",Tone.LETTERS=["C","D","E","F","G","A","B"],Tone.PITCHES=[0,2,4,5,7,9,11];class Printable{}